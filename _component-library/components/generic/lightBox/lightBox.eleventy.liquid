{% assign mainTrack = id | replace: "-", "" %}
{% assign subTrack = id | replace: "-", "" | append: "sub" %}

{% capture imageClasses %}
h-full w-auto max-w-full object-contain cursor-pointer border-2 
  {% endcapture %}
<dialog id="modal-{{id}}" class="c-lightBox fixed top-0 z-[900] h-full max-h-screen w-full p-4 opacity-0 open:bg-slate-950 open:bg-opacity-60 open:backdrop-blur-lg sm:p-10 overflow-hidden">

  <div class="flex flex-col gap-4 h-full">
    <button
      aria-label="Close image"
      class="sticky top-0 self-end z-10 font-bold text-white opacity-60"
      _="
          on click
          set modal to #modal-{{id}}
          transition #modal-{{id}} opacity to 0 over 0.2s settle then
          modal.close()
          call destroyLightBox_{{id}}()
          ">
      {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "x-mark" iconType: "solid" iconSize: 'large' roundedBorder: false color: "#ffffff" %}
    </button>

    <!-- Main Carousel -->
    <div class="flex-1 flex items-center justify-center overflow-hidden {{mainTrack}}">
      <div class="glide__track h-full w-full max-h-full" data-glide-el="track">
        <ul class="glide__slides h-full flex items-center justify-center">
          {% for image in images %}
            <li class="glide__slide max-h-full max-w-full flex items-center justify-center">
              {% bookshop "generic/image" bind: image class: "max-h-[75vh] w-auto h-auto object-contain" %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    {% if images.size >= 5 %}
      <!-- Thumbnail Carousel -->
      <div class="h-24 sm:h-32 mt-2 {{subTrack}}">
        <div class="glide__track h-full " data-glide-el="track">
          <ul class="glide__slides h-full items-center">
            {% for image in images %}
              <li class="glide__slide flex h-full  items-center justify-center ">
                {% bookshop "generic/image" bind: image class: imageClasses %}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
</dialog>

{% if images.size < 5 %}
{% endif %}


<script src="/assets/js/glide.js"></script>
<script src="/assets/js/glide.js"></script>
<script>
  const mainCarousel = new Glide('.{{ mainTrack }}', {
    type: 'carousel',
    perView: 1,
    gap: 20,
    perTouch: 10
  });

  const thumbCarousel = new Glide('.{{ subTrack }}', {
    type: 'slider',
    perView: {% if images.size < 10 %}{{ images.size }}{% else %}10{% endif %},
    gap: 15,
    bound: true,
    breakpoints: {
      1024: { perView: {% if images.size < 7 %}{{ images.size }}{% else %}7{% endif %} },
      768: { perView: {% if images.size < 5 %}{{ images.size }}{% else %}5{% endif %} },
      640: { perView: 3 }
    }
  });

  mainCarousel.mount();

  {% if images.size >= 5 %}thumbCarousel.mount();{% endif %}
  

  // Sync thumbnail clicks to main
  document.addEventListener("DOMContentLoaded", function () {
    const thumbnails = document.querySelectorAll('.{{ subTrack }} .glide__slide');

    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', () => {
        mainCarousel.go(`=${index}`);
      });
    });
  });
  function destroyLightBox_{{ id }}(){

    try { mainCarousel.destroy(); } catch (e) {}
    try { thumbCarousel.destroy(); } catch (e) {}
  }
  function openLightbox_{{ id }}() {
  const modal = document.getElementById("modal-{{ id }}");

  if (!modal.open) modal.showModal();
  
  requestAnimationFrame(() => {
    // Unmount and re-mount for safety
    try { mainCarousel.destroy(); } catch (e) {}
    try { thumbCarousel.destroy(); } catch (e) {}

  {% if images.size >= 5 %}thumbCarousel.mount();{% endif %}
    mainCarousel.mount();

    // Sync thumbnails again
    const thumbnails = modal.querySelectorAll('.{{ subTrack }} .glide__slide');
    thumbnails.forEach((thumb, index) => {
      thumb.addEventListener('click', () => {
        mainCarousel.go(`=${index}`);
      });
    });
  });
  }
</script>