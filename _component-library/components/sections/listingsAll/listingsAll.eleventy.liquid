{% assign color_group = styles.color_group %}
{% if env_bookshop_live %}
{% assign listingsItems = collections.listings %}    
{% elsif pagination.items %}
 {% assign listingsItems = pagination.items %}
{% else %}
{% assign listingsItems = collections.listings %} 
{% endif %}
{% comment %}
  don't forget to make use of pagination.items

{% endcomment %}
{% assign listingCardStyle = 'generic/listings/' | append: styles.listingCardStyle | append: "ListingCard" %}
<div class="c-listingsAll componentcontainer bg-{{styles.color_group}}-backgroundcolor  text-{{styles.color_group}}-textcolor">
  <section
    class="basecontainer w-full"
    {% if content.sectionId %}
              {% bookshop "util/IdScrollEvent" sectionId: content.sectionId %}
    {% endif %}>
        {% if content.heading %}
      {% bookshop {{content.heading._bookshop_name}} bind: content.heading %}
    {% endif %}
  {% if listingsItems.size > 0 %}  
    <ul class="mt-20 flex flex-wrap justify-center gap-8">
        {% for listing in listingsItems %}
{% assign currentTime = "now" | date: "%Y-%m-%dT%H:%M:%S", 360 %}
            {% assign showListing = false %}

            {# 1. Check Expired (Highest Priority) #}
            {% if listing.data.canExpire == true and listing.data.expireDate <= currentTime %}
                {% if content.showExpired %}
                    {% assign showListing = true %}
                {% endif %}
                {% unless showListing %}
                    {% continue %}
                {% endunless %}
            {% endif %}

            {# 2. Check Disqualified (Second Highest Priority) #}
            {% assign isDisqualified = false %}
            {% for tag in listing.data.tags %}
                {% if tag in listings.disqualificationTags %}
                    {% assign isDisqualified = true %}
                    {% break %}
                {% endif %}
            {% endfor %}
            {% if isDisqualified %}
                {% if content.showDisqualified %}
                    {% assign showListing = true %}
                {% endif %}
                {% unless showListing %}
                    {% continue %}
                {% endunless %}
            {% endif %}

            {# 3. Check Available (Third Highest Priority) #}
            {% assign isAvailable = false %}
            {% for tag in listing.data.tags %}
                {% if tag in listings.availableTags %}
                    {% assign isAvailable = true %}
                    {% break %}
                {% endif %}
            {% endfor %}
            {% if isAvailable %}
                {% if content.showAvailable %}
                    {% assign showListing = true %}
                {% endif %}
                {% unless showListing %}
                    {% continue %}
                {% endunless %}
            {% endif %}

            {# 4. Check General (Lowest Priority) #}
            {% assign isGeneral = true %}
            {% for tag in listing.data.tags %}
                {% if tag in listings.availableTags or tag in listings.disqualificationTags %}
                    {% assign isGeneral = false %}
                    {% break %}
                {% endif %}
            {% endfor %}
            {% if isGeneral %}
                {% if content.showGeneral %}
                    {% assign showListing = true %}
                {% endif %}
                {% unless showListing %}
                    {% continue %}
                {% endunless %}
            {% endif %}
          {% capture featuredImage %}
            {% if listing.data.listingImage and listing.data.listingImage != "" %}
             image:
                imagePath: {{listing.data.listingImage}}
                imageAlt: {{listing.data.imageAltText}}
            {% else %}
            image:
                imagePath: {{listings.defaultImage.imagePath}}
                imageAlt: {{listings.defaultImage.imageAlt}}
            {% endif %}
          {% endcapture %}
          {% capture card %}
          listingTitle: {{listing.data.title | stringifyFilter}}
          listingUrl: {{listing.url}}
          keyInformation: {{listing.data.keyInformation | stringifyFilter}}
          expires: {{listing.data.canExpire}}
          listingExpiration: {{listing.data.expireDate}}
          listingTags: {{listing.data.tags | ymlify | split: "," | json}}
          {{featuredImage | strip | log}}
          color_group: {{styles.card_color_group}}
          colorFromGroup: {{styles.colorFromGroup}}
          {% endcapture %}
          {% assign card = card | ymlify %}
          {% bookshop {{listingCardStyle}} bind: card %}
        {% endfor %}
      </ul>
      {% elsif content.noListingsHeading %}
    {% bookshop {{contents.noListingsHeading._bookshop_name}} bind: contents.noListingsHeading %}
  {% endif %} 
    
    
    </section>
</div>


<script type="module">
      document.addEventListener("DOMContentLoaded", async () => {
        const pagefind = await import("/pagefind/pagefind.js");
    // Initialize Pagefind
    await pagefind.init();

    // Example function to filter by tags
    async function filterListings(tag) {
      const results = await pagefind.search("", { filters: { tag: [tag] } });

      // Render results
      renderResults(results.results);
    }

    console.log("Pagefind initialized.");
    // Example trigger for filtering
    document.querySelectorAll('.filter-button').forEach(button => {
      button.addEventListener('click', () => filterListings(button.dataset.tag));
    });
  });
</script>